{% extends "base.html" %}

{% block content %}
<script src="https://unpkg.com/wavesurfer.js@5.2.0"></script>
<script src="https://unpkg.com/wavesurfer.js@5.2.0/dist/plugin/wavesurfer.regions.min.js"></script>
<script src="/static/audio-editor.js"></script>

<div class="audio-editor">
    <h2>Gravar e Editar Áudio</h2>
    <div id="waveform" style="margin-top: 20px;"></div>
    <div id="statusMessage" style="margin-top: 20px; color: green;"></div>
    <div class="audio-controls">
        <button id="recordButton">Iniciar Gravação</button>
        <button id="stopButton" disabled>Parar Gravação</button>
        <button id="playRegionButton" disabled>Ouvir Áudio</button>
        <button id="cutButton" disabled>Cortar Áudio</button>
    </div>
</div>

<style>
    /* Botão de gravação */
    #recordButton {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 120px;
        height: 40px;
        border: none;
        border-radius: 20px;
        background-color: gray;
        color: white;
        font-size: 16px;
        cursor: pointer;
        position: relative;
    }

    #recordButton.recording {
        background-color: red;
        animation: blink 1s infinite;
    }

    @keyframes blink {
        0%, 50% {
            background-color: red;
        }
        50%, 100% {
            background-color: gray;
        }
    }
</style>

<script>
    let isRecording = false;
    let audioContext;
    let mediaRecorder;
    let audioChunks = [];
    let mediaStream;

    document.addEventListener("DOMContentLoaded", () => {
        const recordButton = document.getElementById("recordButton");
        const stopButton = document.getElementById("stopButton");
        const playRegionButton = document.getElementById("playRegionButton");
        const cutButton = document.getElementById("cutButton");

        wavesurfer = initializeWaveSurfer("#waveform");

        const resetRecordingState = () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            if (wavesurfer) {
                wavesurfer.empty();
                wavesurfer.clearRegions();
            }

            audioChunks = [];
            isRecording = false;

            recordButton.classList.remove("recording");
            recordButton.disabled = false;
            stopButton.disabled = true;
            playRegionButton.disabled = true;
            cutButton.disabled = true;
        };

        // Gravação de áudio
        recordButton.addEventListener("click", async () => {
            if (isRecording) return;

            resetRecordingState(); // Reinicia tudo antes de gravar
            isRecording = true;
            recordButton.classList.add("recording");
            recordButton.disabled = true;
            stopButton.disabled = false;

            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(mediaStream, { mimeType: "audio/webm" });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const blob = new Blob(audioChunks, { type: "audio/webm" });
                    audioChunks = [];
                    wavesurfer.loadBlob(blob);

                    wavesurfer.on("ready", () => {
                        playRegionButton.disabled = false;
                        cutButton.disabled = false;
                        createInitialRegion();
                    });
                };

                mediaRecorder.start();
            } catch (error) {
                alert("Erro ao acessar o microfone.");
                console.error(error);
                resetRecordingState();
            }
        });

        stopButton.addEventListener("click", () => {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            isRecording = false;
            recordButton.classList.remove("recording");
            recordButton.disabled = false;
            stopButton.disabled = true;
        });

        // Controles de edição
        playRegionButton.addEventListener("click", playRegion);
        cutButton.addEventListener("click", cutAudio);
    });
</script>
{% endblock %}
